name: ğŸ•µï¸ DIAGNOSTIC SERVEUR EAS (CORRIGÃ‰)

on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ— Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ— Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # --- ETAPE MANQUANTE AJOUTÃ‰E ---
      - name: ğŸ“¦ Installation des dÃ©pendances (CRUCIAL)
        run: npm install --legacy-peer-deps

      - name: ğŸ— Installation EAS CLI
        run: npm install -g eas-cli

      - name: ğŸ” TEST 1 - INFO PROJET (VÃ©rifie l'ID)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_PRAXIS_SECRET }}
        run: |
          echo "Tentative de connexion au projet..."
          # Si l'ID dans app.config.js est faux, Ã§a plantera ici
          npx eas project:info

      - name: ğŸ” TEST 2 - LISTE DES MISES Ã€ JOUR (Production)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_PRAXIS_SECRET }}
        run: |
          echo "RÃ©cupÃ©ration des mises Ã  jour sur le canal 'production'..."
          # On cherche une ligne avec "Runtime Version: 4.1.0"
          npx eas update:list --branch production --limit 5 || echo "âš ï¸ Pas encore de mises Ã  jour ou erreur de branche"

      - name: ğŸ” TEST 3 - LECTURE CONFIG LOCALE
        run: |
          echo "VÃ©rification de la configuration locale :"
          grep "url:" app.config.js
          grep "runtimeVersion:" app.config.js

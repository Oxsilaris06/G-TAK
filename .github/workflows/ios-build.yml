name: Build iOS (Unsigned IPA for SideStore)

on:
  workflow_dispatch: # D√©clenchement manuel via l'interface GitHub

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest # Obligatoire pour compiler pour iOS

    steps:
      - name: üèó Setup Repository
        uses: actions/checkout@v4

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: üèó Setup Java (for Expo tools)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: ‚öôÔ∏è Expo Prebuild
        run: npx expo prebuild --platform ios --no-install
        # Cela g√©n√®re le dossier /ios bas√© sur app.config.js

      - name: üîß Install Pods
        cd ios
        run: pod install --repo-update

      - name: üî® Build Unsigned .app with Xcode
        run: |
          cd ios
          # On cherche le nom du workspace (souvent GTAK.xcworkspace)
          WORKSPACE=$(find . -name "*.xcworkspace" | head -n 1)
          SCHEME="G-TAK" 
          
          # Si le scheme n'est pas trouv√© avec le nom exact, on essaie de le d√©duire (souvent le nom sans tirets ou "gtak")
          # Pour G-TAK, Expo g√©n√®re souvent le scheme "GTAK" ou "gtak"
          if ! xcodebuild -workspace "$WORKSPACE" -list | grep -q "$SCHEME"; then
            SCHEME="GTAK"
          fi
          
          echo "Building Scheme: $SCHEME from Workspace: $WORKSPACE"

          # Compilation pour ARM64 (Device) sans signature
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ./build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            DISABLE_MANUAL_TARGET_ORDER_BUILD_WARNING=YES \
            COMPILER_INDEX_STORE_ENABLE=NO

      - name: üì¶ Package into .ipa (Payload)
        run: |
          cd ios
          mkdir Payload
          # On d√©place l'application compil√©e (.app) dans un dossier Payload
          # Le chemin d√©pend du derivedDataPath d√©fini plus haut
          mv ./build/Build/Products/Release-iphoneos/*.app Payload/
          
          # On zippe le dossier Payload pour cr√©er l'IPA
          zip -r GTAK-unsigned.ipa Payload

      - name: üì§ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: ios/GTAK-unsigned.ipa
          retention-days: 14

name: Build iOS (Unsigned IPA for SideStore)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: üèó Setup Repository
        uses: actions/checkout@v4

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üèó Setup Java (for Expo tools)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üì¶ Install Dependencies
        run: |
          npm install --legacy-peer-deps
          npx expo install --fix -- --legacy-peer-deps

      # Nettoyage profond pour forcer la r√©application des patches sur node_modules si n√©cessaire
      # et s'assurer que le dossier ios est recr√©√© proprement
      - name: üßπ Clean Build Environment
        run: |
          rm -rf ios
          rm -rf android
          rm -rf node_modules/.cache
          # On ne supprime PAS node_modules entier pour gagner du temps, 
          # le patch du plugin s'appliquera sur les fichiers existants.

      - name: ‚öôÔ∏è Expo Prebuild
        # C'est ici que 'withMapLibreImportPatch' va s'ex√©cuter et modifier le code source
        run: npx expo prebuild --platform ios --no-install

      - name: üîß Install Pods
        run: |
          cd ios
          pod install --repo-update
        env:
          LANG: en_US.UTF-8

      - name: üî® Build Unsigned .app with Xcode
        run: |
          cd ios
          
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          SCHEME="Praxis"
          
          DERIVED_DATA_PATH="$(pwd)/build_xc"
          mkdir -p "$DERIVED_DATA_PATH"

          # Ajout de CLANG_ALLOW_NON_MODULAR... dans la ligne de commande aussi par s√©curit√©
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            DISABLE_MANUAL_TARGET_ORDER_BUILD_WARNING=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES=YES \
            GCC_WARN_INHIBIT_ALL_WARNINGS=YES \
            SWIFT_SUPPRESS_WARNINGS=YES \
            ONLY_ACTIVE_ARCH=NO

      - name: üì¶ Package into .ipa (Payload)
        run: |
          cd ios
          DERIVED_DATA_PATH="$(pwd)/build_xc"
          mkdir Payload
          
          APP_PATH=$(find "$DERIVED_DATA_PATH/Build/Products/Release-iphoneos" -name "*.app" -maxdepth 1 | grep -v "Tests" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå ERREUR : Aucun fichier .app trouv√©."
            ls -R "$DERIVED_DATA_PATH/Build/Products/Release-iphoneos"
            exit 1
          fi
          
          echo "‚úÖ Packaging de : $APP_PATH"
          cp -r "$APP_PATH" Payload/
          zip -r GTAK-unsigned.ipa Payload

      - name: üì§ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ios-v${{ github.run_number }}
          name: "Praxis iOS Unsigned #${{ github.run_number }}"
          files: ios/GTAK-unsigned.ipa
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

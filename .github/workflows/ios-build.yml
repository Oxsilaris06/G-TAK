name: Build iOS (Unsigned IPA for SideStore)

on:
  workflow_dispatch: # D√©clenchement manuel via l'interface GitHub

permissions:
  contents: write

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest # Obligatoire pour compiler pour iOS
    timeout-minutes: 60

    steps:
      - name: üèó Setup Repository
        uses: actions/checkout@v4

      # --- ETAPE DE V√âRIFICATION ---
      - name: üîç V√âRIFICATION DU FICHIER CONFIG (Preuve)
        run: |
          echo "====================================================="
          echo "CONTENU DE app.config.js SUR LE SERVEUR DE BUILD :"
          echo "====================================================="
          cat app.config.js
          echo "====================================================="
          
          if grep -q "57c6 -4432" app.config.js; then
            echo "‚ùå ERREUR CRITIQUE D√âTECT√âE : L'espace est PR√âSENT dans le fichier !"
            exit 1
          else
            echo "‚úÖ SUCC√àS : Aucun espace d√©tect√© dans l'ID du fichier."
          fi

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # Cache d√©sactiv√© pour √©viter les erreurs de lockfile absent

      - name: üèó Setup Java (for Expo tools)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üì¶ Install Dependencies
        run: |
          npm install --legacy-peer-deps
          npx expo install --fix -- --legacy-peer-deps

      # Prebuild g√©n√®re les dossiers natifs (/ios)
      - name: ‚öôÔ∏è Expo Prebuild
        run: npx expo prebuild --platform ios --clean --no-install

      # --- ETAPE CRITIQUE : PATCH PODFILE ---
      - name: üîß Patch Podfile for iOS Version
        run: |
          cd ios
          # Au lieu d'ajouter un 2√®me hook post_install (ce qui est interdit), 
          # on ins√®re nos modifications DANS le hook existant g√©n√©r√© par Expo.
          # On cherche la ligne "post_install do |installer|" et on ajoute nos r√®gles juste apr√®s.
          
          sed -i '' '/post_install do |installer|/a\
            installer.pods_project.targets.each do |target|\
              target.build_configurations.each do |config|\
                config.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = "13.4"\
                config.build_settings["GCC_WARN_INHIBIT_ALL_WARNINGS"] = "YES"\
              end\
            end\
          ' Podfile
          
          echo "‚úÖ Podfile patch√© : Injection de la config iOS 13.4 dans le hook existant."
          # Debug: V√©rifier le contenu du fichier
          head -n 50 Podfile

      - name: üîß Install Pods
        run: |
          cd ios
          pod install --repo-update

      - name: üî® Build Unsigned .app with Xcode
        run: |
          cd ios
          
          # --- CORRECTION CRITIQUE DU WORKSPACE ---
          # On cherche d'abord le workspace CocoaPods √† la racine (ex: Praxis.xcworkspace)
          # On √©vite le pi√®ge de trouver ./Praxis.xcodeproj/project.xcworkspace
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          
          if [ -z "$WORKSPACE" ]; then
             echo "‚ö†Ô∏è Pas de workspace racine trouv√©, recherche plus large (en excluant xcodeproj)..."
             WORKSPACE=$(find . -name "*.xcworkspace" -not -path "*.xcodeproj/*" | head -n 1)
          fi
          
          echo "‚úÖ Workspace Correct trouv√© : $WORKSPACE"
          
          # D√âTECTION INTELLIGENTE DU SCHEME
          # 1. On cherche explicitement "Praxis" (nom dans app.config.js)
          if xcodebuild -workspace "$WORKSPACE" -list | grep -q "Praxis"; then
            SCHEME="Praxis"
          # 2. Sinon on cherche "GTAK"
          elif xcodebuild -workspace "$WORKSPACE" -list | grep -q "GTAK"; then
            SCHEME="GTAK"
          else
            # 3. FALLBACK ULTIME : On prend le premier scheme de la liste
            SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list | sed -n '/Schemes:/,$p' | tail -n +2 | head -n 1 | xargs)
          fi
          
          if [ -z "$SCHEME" ]; then
             echo "‚ùå ERREUR : Aucun Scheme trouv√©. For√ßage √† 'Praxis'."
             SCHEME="Praxis"
          fi
          
          echo "‚úÖ SCHEME S√âLECTIONN√â : $SCHEME"
          
          # --- CORRECTION CHEMINS ---
          # Utilisation d'un chemin ABSOLU pour DerivedData pour √©viter les erreurs de module map
          DERIVED_DATA_PATH="$(pwd)/build_xc"
          mkdir -p "$DERIVED_DATA_PATH"

          # Compilation pour ARM64 (Device) sans signature
          # Flags ajout√©s :
          # - GCC_TREAT_WARNINGS_AS_ERRORS=NO : Ignore les warnings C/ObjC
          # - SWIFT_TREAT_WARNINGS_AS_ERRORS=NO : Ignore les warnings Swift
          # - COMPILER_INDEX_STORE_ENABLE=NO : Acc√©l√®re un peu le build et r√©duit l'espace
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            DISABLE_MANUAL_TARGET_ORDER_BUILD_WARNING=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES=YES \
            GCC_TREAT_WARNINGS_AS_ERRORS=NO \
            SWIFT_TREAT_WARNINGS_AS_ERRORS=NO \
            ONLY_ACTIVE_ARCH=NO

      - name: üì¶ Package into .ipa (Payload)
        run: |
          cd ios
          # On r√©cup√®re le chemin absolu utilis√© pr√©c√©demment
          DERIVED_DATA_PATH="$(pwd)/build_xc"
          
          mkdir Payload
          # On d√©place l'application compil√©e (.app) dans un dossier Payload
          # Note: Le chemin peut varier l√©g√®rement, on utilise find pour √™tre s√ªr
          APP_PATH=$(find "$DERIVED_DATA_PATH/Build/Products/Release-iphoneos" -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå ERREUR : Aucun fichier .app trouv√© dans $DERIVED_DATA_PATH"
            exit 1
          fi
          
          cp -r "$APP_PATH" Payload/
          
          # On zippe le dossier Payload pour cr√©er l'IPA
          zip -r GTAK-unsigned.ipa Payload

      - name: üì§ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ios-v${{ github.run_number }}
          name: "Praxis iOS Unsigned #${{ github.run_number }}"
          files: ios/GTAK-unsigned.ipa
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

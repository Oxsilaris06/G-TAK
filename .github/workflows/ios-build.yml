name: Build iOS (Unsigned IPA for SideStore)

on:
  workflow_dispatch: # D√©clenchement manuel via l'interface GitHub

permissions:
  contents: write

jobs:
  build-ios:
    name: Build iOS IPA
    # UTILISATION DE MACOS 14 (Sonoma - ARM64)
    # Xcode 15.x est le d√©faut sur cette image, ce qui est plus stable que Xcode 16 (macos-15)
    # pour les anciennes d√©pendances React Native.
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: üèó Setup Repository
        uses: actions/checkout@v4

      # --- ETAPE DE V√âRIFICATION ---
      - name: üîç V√âRIFICATION DU FICHIER CONFIG (Preuve)
        run: |
          echo "====================================================="
          echo "CONTENU DE app.config.js SUR LE SERVEUR DE BUILD :"
          echo "====================================================="
          cat app.config.js
          echo "====================================================="
          
          if grep -q "57c6 -4432" app.config.js; then
            echo "‚ùå ERREUR CRITIQUE D√âTECT√âE : L'espace est PR√âSENT dans le fichier !"
            exit 1
          else
            echo "‚úÖ SUCC√àS : Aucun espace d√©tect√© dans l'ID du fichier."
          fi

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # Cache d√©sactiv√© pour √©viter les erreurs de lockfile absent

      - name: üèó Setup Java (for Expo tools)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üì¶ Install Dependencies
        run: |
          npm install --legacy-peer-deps
          npx expo install --fix -- --legacy-peer-deps

      # --- PATCH EXPO-DEVICE (FIX CRITIQUE) ---
      # Fix pour l'erreur "cannot find 'TARGET_OS_SIMULATOR' in scope" avec Xcode 15+
      # NOTE: Ce patch est maintenant aussi appliqu√© via le plugin dans app.config.js
      # mais on le garde ici pour double s√©curit√©
      - name: üöë Patch expo-device (TARGET_OS_SIMULATOR)
        run: |
          echo "Patching expo-device for Xcode 15 compatibility..."
          # On remplace la v√©rification dynamique par 'false' car on compile pour un DEVICE physique (Release)
          # Cela corrige l'erreur de compilation imm√©diate.
          # Le fichier est g√©n√©ralement dans node_modules/expo-device/ios/UIDevice.swift
          DEVICE_SWIFT=$(find node_modules/expo-device/ios -name "UIDevice.swift" | head -n 1)
          
          if [ -f "$DEVICE_SWIFT" ]; then
            echo "üìÅ Fichier trouv√© : $DEVICE_SWIFT"
            
            # V√©rification avant patch
            if grep -q "TARGET_OS_SIMULATOR" "$DEVICE_SWIFT"; then
              echo "üîß Application du patch..."
              # CORRECTION: Supprimer '' apr√®s -i pour macOS
              sed -i.bak 's/return TARGET_OS_SIMULATOR != 0/return false/g' "$DEVICE_SWIFT"
              
              # V√©rification apr√®s patch
              if grep -q "return false" "$DEVICE_SWIFT" && ! grep -q "TARGET_OS_SIMULATOR" "$DEVICE_SWIFT"; then
                echo "‚úÖ Patch appliqu√© avec succ√®s sur UIDevice.swift"
              else
                echo "‚ö†Ô∏è Le patch n'a pas √©t√© appliqu√© correctement"
                cat "$DEVICE_SWIFT"
              fi
            else
              echo "‚ÑπÔ∏è Le fichier ne contient pas TARGET_OS_SIMULATOR (d√©j√† patch√©?)"
            fi
          else
            echo "‚ö†Ô∏è UIDevice.swift non trouv√©, le plugin app.config.js le patchera lors du prebuild"
          fi


      # Prebuild g√©n√®re les dossiers natifs (/ios)
      - name: ‚öôÔ∏è Expo Prebuild
        run: |
          echo "üîß Lancement du prebuild iOS..."
          npx expo prebuild --platform ios --clean --no-install
          echo "‚úÖ Prebuild termin√©"



      - name: üîß Add MapLibre SDK to Podfile and Install
        run: |
          cd ios
          
          echo "üìã Podfile g√©n√©r√© par Expo:"
          head -n 30 Podfile
          
          echo ""
          echo "üîß Ajout explicite de MapLibre SDK au Podfile..."
          
          if ! grep -q "pod 'MapLibre'" Podfile; then
            # Utiliser awk pour ins√©rer MapLibre apr√®s use_expo_modules!
            awk '/use_expo_modules!/ {
              print $0
              print ""
              print "  # MapLibre SDK requis pour @maplibre/maplibre-react-native"
              print "  pod '\''MapLibre'\'', '\''~> 6.0'\'', :modular_headers => true"
              next
            }
            { print }' Podfile > Podfile.tmp && mv Podfile.tmp Podfile
            
            echo "‚úÖ MapLibre SDK ajout√© au Podfile"
          else
            echo "‚ÑπÔ∏è MapLibre d√©j√† pr√©sent"
          fi
          
          echo ""
          echo "üìã Podfile modifi√©:"
          cat Podfile
          
          echo ""
          echo "üì¶ Installation des pods avec logging verbeux..."
          pod install --repo-update --verbose 2>&1 | tee pod_install.log
          
          echo ""
          echo "üîç MURPHY PATCH: V√©rification de l'installation de MapLibre..."
          
          # V√©rifier dans Podfile.lock
          if grep -q "MapLibre" Podfile.lock; then
            echo "‚úÖ MapLibre trouv√© dans Podfile.lock"
            grep -A 3 "MapLibre" Podfile.lock
          else
            echo "‚ùå ERREUR CRITIQUE: MapLibre NOT in Podfile.lock!"
            echo "üìã Contenu de Podfile.lock:"
            head -n 50 Podfile.lock
            exit 1
          fi
          
          # V√©rifier le r√©pertoire Pods
          if [ -d "Pods/MapLibre" ]; then
            echo "‚úÖ R√©pertoire Pods/MapLibre existe"
            ls -la Pods/MapLibre/ | head -n 20
          else
            echo "‚ùå ERREUR: Pods/MapLibre n'existe pas!"
            echo "üìÅ Contenu de Pods/:"
            ls -la Pods/ | grep -i map || echo "Aucun pod MapLibre trouv√©"
            
            echo ""
            echo "üö® MURPHY PATCH ACTIV√â: Installation manuelle de MapLibre..."
            
            # Forcer l'installation manuelle
            pod repo update
            pod install --repo-update --clean-install
            
            # V√©rifier √† nouveau
            if [ ! -d "Pods/MapLibre" ]; then
              echo "‚ùå √âchec de l'installation manuelle de MapLibre"
              echo "üìã Logs d'installation:"
              cat pod_install.log | grep -i maplibre || echo "Aucune mention de MapLibre dans les logs"
              exit 1
            fi
          fi
          
          echo "‚úÖ Pods install√©s avec succ√®s"

      # V√©rification finale avant le build
      - name: üîç Final MapLibre Verification
        run: |
          cd ios
          
          echo "üîç V√©rification finale de MapLibre SDK..."
          
          # V√©rifier le framework
          echo "üì¶ Recherche du framework MapLibre..."
          find Pods -name "*.framework" -path "*MapLibre*" 2>/dev/null || echo "‚ö†Ô∏è Aucun framework MapLibre trouv√©"
          
          # V√©rifier les headers
          echo ""
          echo "üìÑ Recherche des headers MapLibre..."
          find Pods/MapLibre -name "*.h" 2>/dev/null | head -n 10 || echo "‚ö†Ô∏è Aucun header trouv√©"
          
          # V√©rifier la configuration du pod
          echo ""
          echo "‚öôÔ∏è Configuration MapLibre dans Podfile.lock:"
          grep -A 10 "MapLibre" Podfile.lock || echo "‚ùå MapLibre absent de Podfile.lock"
          
          echo ""
          echo "‚úÖ V√©rification termin√©e"

      - name: üî® Build Unsigned .app with Xcode
        run: |
          cd ios
          
          # --- CORRECTION CRITIQUE DU WORKSPACE ---
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          if [ -z "$WORKSPACE" ]; then
             echo "‚ö†Ô∏è Pas de workspace racine trouv√©, recherche plus large..."
             WORKSPACE=$(find . -name "*.xcworkspace" -not -path "*.xcodeproj/*" | head -n 1)
          fi
          echo "‚úÖ Workspace Correct trouv√© : $WORKSPACE"
          
          # D√âTECTION INTELLIGENTE DU SCHEME
          if xcodebuild -workspace "$WORKSPACE" -list | grep -q "Praxis"; then
            SCHEME="Praxis"
          elif xcodebuild -workspace "$WORKSPACE" -list | grep -q "GTAK"; then
            SCHEME="GTAK"
          else
            SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list | sed -n '/Schemes:/,$p' | tail -n +2 | head -n 1 | xargs)
          fi
          
          if [ -z "$SCHEME" ]; then
             echo "‚ùå ERREUR : Aucun Scheme trouv√©. For√ßage √† 'Praxis'."
             SCHEME="Praxis"
          fi
          echo "‚úÖ SCHEME S√âLECTIONN√â : $SCHEME"
          
          # Utilisation d'un chemin ABSOLU pour DerivedData
          DERIVED_DATA_PATH="$(pwd)/build_xc"
          mkdir -p "$DERIVED_DATA_PATH"

          # Compilation pour ARM64 (Device) sans signature
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            DISABLE_MANUAL_TARGET_ORDER_BUILD_WARNING=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES=YES \
            GCC_TREAT_WARNINGS_AS_ERRORS=NO \
            SWIFT_TREAT_WARNINGS_AS_ERRORS=NO \
            ONLY_ACTIVE_ARCH=NO

      - name: üì¶ Package into .ipa (Payload)
        run: |
          cd ios
          DERIVED_DATA_PATH="$(pwd)/build_xc"
          
          mkdir Payload
          # --- MURPHY FIX #4 : Trouver le bon .app ---
          # On cherche sp√©cifiquement l'app qui ne contient pas 'Tests' et qui est dans le dossier Release
          APP_PATH=$(find "$DERIVED_DATA_PATH/Build/Products/Release-iphoneos" -name "*.app" -maxdepth 1 | grep -v "Tests" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå ERREUR : Aucun fichier .app trouv√© dans $DERIVED_DATA_PATH"
            ls -R "$DERIVED_DATA_PATH/Build/Products/Release-iphoneos"
            exit 1
          fi
          
          echo "‚úÖ Packaging de l'application : $APP_PATH"
          cp -r "$APP_PATH" Payload/
          
          # On zippe le dossier Payload pour cr√©er l'IPA
          zip -r GTAK-unsigned.ipa Payload

      - name: üì§ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ios-v${{ github.run_number }}
          name: "Praxis iOS Unsigned #${{ github.run_number }}"
          files: ios/GTAK-unsigned.ipa
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Build iOS (Unsigned IPA for SideStore)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: üèó Setup Repository
        uses: actions/checkout@v4

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üèó Setup Java (for Expo tools)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üì¶ Install Dependencies
        run: |
          npm install --legacy-peer-deps
          npx expo install --fix -- --legacy-peer-deps

      # --- ETAPE DE NETTOYAGE CRITIQUE ---
      # On s'assure qu'aucun dossier ios g√©n√©r√© pr√©c√©demment ne tra√Æne
      # pour garantir que le prebuild utilise bien notre nouveau app.config.js
      - name: üßπ Clean Previous Builds
        run: |
          rm -rf ios
          rm -rf android

      # Prebuild g√©n√®re les dossiers natifs (/ios) en utilisant app.config.js
      # C'est ici que nos plugins customs vont modifier le Podfile et UIDevice.swift
      - name: ‚öôÔ∏è Expo Prebuild
        run: npx expo prebuild --platform ios --no-install

      # Installation des Pods propre, sans script Ruby externe
      - name: üîß Install Pods
        run: |
          cd ios
          pod install --repo-update
        env:
          # Permet d'√©viter l'erreur d'encodage ASCII sur certaines machines CI
          LANG: en_US.UTF-8

      - name: üî® Build Unsigned .app with Xcode
        run: |
          cd ios
          
          # Trouver le workspace
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          echo "‚úÖ Workspace : $WORKSPACE"
          
          # Trouver le Scheme
          SCHEME="Praxis" # On force Praxis car c'est le nom d√©fini dans app.json
          
          DERIVED_DATA_PATH="$(pwd)/build_xc"
          mkdir -p "$DERIVED_DATA_PATH"

          # Compilation
          # Note: On force CLANG_ALLOW_NON_MODULAR... ici aussi par s√©curit√©
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            DISABLE_MANUAL_TARGET_ORDER_BUILD_WARNING=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES=YES \
            GCC_WARN_INHIBIT_ALL_WARNINGS=YES \
            SWIFT_SUPPRESS_WARNINGS=YES \
            ONLY_ACTIVE_ARCH=NO

      - name: üì¶ Package into .ipa (Payload)
        run: |
          cd ios
          DERIVED_DATA_PATH="$(pwd)/build_xc"
          mkdir Payload
          
          # R√©cup√©ration de l'app
          APP_PATH=$(find "$DERIVED_DATA_PATH/Build/Products/Release-iphoneos" -name "*.app" -maxdepth 1 | grep -v "Tests" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå ERREUR : Aucun fichier .app trouv√©."
            exit 1
          fi
          
          echo "‚úÖ Packaging de : $APP_PATH"
          cp -r "$APP_PATH" Payload/
          zip -r GTAK-unsigned.ipa Payload

      - name: üì§ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ios-v${{ github.run_number }}
          name: "Praxis iOS Unsigned #${{ github.run_number }}"
          files: ios/GTAK-unsigned.ipa
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
